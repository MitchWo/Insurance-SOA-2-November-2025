#!/usr/bin/env python3
"""
Where Are You Now JSON Generator

This module provides functionality to generate structured JSON for the "Where Are You Now"
section of an insurance Statement of Advice (SOA) report.

It processes personal details and financial information (assets/liabilities) from fact find
forms to create a comprehensive financial position snapshot with structured output for
LLM-based prose generation.

Created: 2025-01-27
Author: Insurance SOA System
License: Lighthouse Financial
"""

import json
import re
from typing import Dict, List, Any, Optional, Tuple
from datetime import datetime, date
from decimal import Decimal, InvalidOperation


class WhereAreYouNowGenerator:
    """Generator for Where Are You Now JSON structures"""

    # Field mappings for personal details
    PERSONAL_FIELDS = {
        'main_first_name': '144',
        'partner_first_name': '146',
        'date_of_birth': '95',
        'main_self_employed': '482',
        'partner_self_employed': '483',
        'main_occupation': '6',
        'partner_occupation': '40',
        'main_employer': '277',
        'partner_employer': '297',
        'main_annual_income': '10',
        'partner_annual_income': '42',
        'will_epa_status': '501'
    }

    # Field mappings for assets
    ASSET_FIELDS = {
        'house_value': '16',
        'mortgage': '15',
        'total_property_value': '468',
        'total_property_debt': '469',
        'asset_total': '466',
        # KiwiSaver accounts
        'kiwisaver_1_provider': '60',
        'kiwisaver_1_balance': '61',
        'kiwisaver_2_provider': '62',
        'kiwisaver_2_balance': '215',
        'kiwisaver_3_provider': '217',
        'kiwisaver_3_balance': '216',
        # Individual assets (15 pairs)
        'asset_1_name': '33', 'asset_1_value': '26',
        'asset_2_name': '34', 'asset_2_value': '28',
        'asset_3_name': '211', 'asset_3_value': '210',
        'asset_4_name': '35', 'asset_4_value': '50',
        'asset_5_name': '36', 'asset_5_value': '51',
        'asset_6_name': '37', 'asset_6_value': '52',
        'asset_7_name': '38', 'asset_7_value': '53',
        'asset_8_name': '206', 'asset_8_value': '207',
        'asset_9_name': '208', 'asset_9_value': '209',
        'asset_10_name': '212', 'asset_10_value': '213',
        'asset_11_name': '214', 'asset_11_value': '215',
        'asset_12_name': '220', 'asset_12_value': '221',
        'asset_13_name': '222', 'asset_13_value': '223',
        'asset_14_name': '224', 'asset_14_value': '225',
        'asset_15_name': '226', 'asset_15_value': '227'
    }

    # Field mappings for liabilities
    LIABILITY_FIELDS = {
        # Liabilities (5 pairs)
        'liability_1_name': '71', 'liability_1_value': '72',
        'liability_2_name': '73', 'liability_2_value': '74',
        'liability_3_name': '75', 'liability_3_value': '77',
        'liability_4_name': '78', 'liability_4_value': '88',
        'liability_5_name': '89', 'liability_5_value': '90'
    }

    @classmethod
    def generate_where_are_you_now_json(cls,
                                       raw_form_data: Dict[str, Any],
                                       client_name: Optional[str] = None,
                                       is_couple: bool = False) -> Dict[str, Any]:
        """
        Generate comprehensive JSON structure for Where Are You Now section

        Args:
            raw_form_data: Raw form data from Gravity Forms
            client_name: Optional client name for personalization
            is_couple: Whether this is for a couple

        Returns:
            Structured JSON containing personal and financial information
        """
        # Extract personal details
        personal_data = cls._extract_personal_details(raw_form_data)

        # Extract financial data
        assets = cls._extract_assets(raw_form_data)
        liabilities = cls._extract_liabilities(raw_form_data)
        kiwisaver_accounts = cls._extract_kiwisaver(raw_form_data)

        # Calculate key metrics
        total_assets = cls._calculate_total_assets(assets, kiwisaver_accounts, raw_form_data)
        total_liabilities = cls._calculate_total_liabilities(liabilities, raw_form_data)
        net_worth = cls._calculate_net_worth(total_assets, total_liabilities)
        property_equity = cls._calculate_property_equity(raw_form_data)
        total_income = cls._calculate_total_income(personal_data)
        debt_to_income = cls._calculate_debt_to_income_ratio(total_liabilities, total_income)

        # Calculate age
        age_main = cls._calculate_age(personal_data.get('date_of_birth'))

        # Build the comprehensive JSON structure
        return {
            "section_type": "where_are_you_now",
            "timestamp": datetime.now().isoformat(),

            # Raw form data preserved
            "form_data": {
                "personal_details": personal_data,
                "assets": assets,
                "liabilities": liabilities,
                "kiwisaver_accounts": kiwisaver_accounts,
                "raw_fields": cls._get_all_raw_fields(raw_form_data)
            },

            # Processed data for easier consumption
            "processed_data": {
                "financial_summary": {
                    "total_assets": total_assets,
                    "total_liabilities": total_liabilities,
                    "net_worth": net_worth,
                    "property_equity": property_equity,
                    "total_income": total_income,
                    "debt_to_income_ratio": debt_to_income,
                    "kiwisaver_total": sum(acc.get('balance', 0) for acc in kiwisaver_accounts)
                },
                "personal_summary": {
                    "age": age_main,
                    "is_couple": is_couple,
                    "main_occupation": personal_data.get('main_occupation'),
                    "main_employer": personal_data.get('main_employer'),
                    "main_self_employed": personal_data.get('main_self_employed'),
                    "partner_occupation": personal_data.get('partner_occupation') if is_couple else None,
                    "partner_employer": personal_data.get('partner_employer') if is_couple else None,
                    "will_epa_status": personal_data.get('will_epa_status')
                },
                "asset_breakdown": {
                    "property_value": cls._parse_currency(raw_form_data.get(f"f{cls.ASSET_FIELDS['house_value']}", 0)),
                    "investment_properties": cls._parse_currency(raw_form_data.get(f"f{cls.ASSET_FIELDS['total_property_value']}", 0)),
                    "kiwisaver": sum(acc.get('balance', 0) for acc in kiwisaver_accounts),
                    "other_assets": sum(asset.get('value', 0) for asset in assets)
                },
                "liability_breakdown": {
                    "home_mortgage": cls._parse_currency(raw_form_data.get(f"f{cls.ASSET_FIELDS['mortgage']}", 0)),
                    "investment_debt": cls._parse_currency(raw_form_data.get(f"f{cls.ASSET_FIELDS['total_property_debt']}", 0)),
                    "other_liabilities": sum(liability.get('value', 0) for liability in liabilities)
                }
            },

            # Context for prose generation
            "prose_generation": {
                "context": {
                    "client_name": client_name or "the client",
                    "is_couple": is_couple,
                    "pronoun": "they" if is_couple else "they",
                    "possessive": "their",
                    "age_description": cls._get_age_description(age_main),
                    "financial_position": cls._get_financial_position_description(net_worth),
                    "income_level": cls._get_income_level_description(total_income)
                },

                "required_sections": {
                    "personal_summary": {
                        "instruction": "Client age, occupation overview",
                        "max_length": 500,
                        "suggested_content": cls._generate_personal_summary(
                            personal_data, age_main, is_couple, client_name
                        )
                    },
                    "employment_status": {
                        "instruction": "Employment and income details",
                        "max_length": 600,
                        "suggested_content": cls._generate_employment_status(
                            personal_data, total_income, is_couple
                        )
                    },
                    "asset_summary": {
                        "instruction": "Overview of total assets and property",
                        "max_length": 600,
                        "suggested_content": cls._generate_asset_summary(
                            total_assets, assets, raw_form_data
                        )
                    },
                    "liability_summary": {
                        "instruction": "Overview of debts and obligations",
                        "max_length": 500,
                        "suggested_content": cls._generate_liability_summary(
                            total_liabilities, liabilities, raw_form_data
                        )
                    },
                    "net_worth_position": {
                        "instruction": "Net worth and financial strength",
                        "max_length": 400,
                        "suggested_content": cls._generate_net_worth_position(
                            net_worth, total_assets, total_liabilities
                        )
                    },
                    "kiwisaver_status": {
                        "instruction": "KiwiSaver holdings summary",
                        "max_length": 400,
                        "suggested_content": cls._generate_kiwisaver_status(kiwisaver_accounts)
                    },
                    "property_position": {
                        "instruction": "Property portfolio and equity",
                        "max_length": 500,
                        "suggested_content": cls._generate_property_position(
                            property_equity, raw_form_data
                        )
                    },
                    "estate_planning": {
                        "instruction": "Will and EPA status",
                        "max_length": 300,
                        "suggested_content": cls._generate_estate_planning(
                            personal_data.get('will_epa_status'), is_couple
                        )
                    },
                    "key_observations": {
                        "instruction": "Notable financial aspects",
                        "max_length": 500,
                        "suggested_content": cls._generate_key_observations(
                            net_worth, debt_to_income, kiwisaver_accounts, property_equity
                        )
                    },
                    "financial_capacity": {
                        "instruction": "Ability to handle premiums",
                        "max_length": 400,
                        "suggested_content": cls._generate_financial_capacity(
                            total_income, net_worth, debt_to_income
                        )
                    }
                }
            },

            # Expected LLM response structure
            "expected_response": {
                "format": "structured_json",
                "schema": "where_are_you_now_v1",
                "fields": [
                    "personal_summary", "employment_status", "asset_summary",
                    "liability_summary", "net_worth_position", "kiwisaver_status",
                    "property_position", "estate_planning", "key_observations",
                    "financial_capacity"
                ],
                "validation_rules": {
                    "all_fields_required": True,
                    "max_lengths_enforced": True,
                    "character_limits": {
                        "personal_summary": 500,
                        "employment_status": 600,
                        "asset_summary": 600,
                        "liability_summary": 500,
                        "net_worth_position": 400,
                        "kiwisaver_status": 400,
                        "property_position": 500,
                        "estate_planning": 300,
                        "key_observations": 500,
                        "financial_capacity": 400
                    }
                }
            }
        }

    @classmethod
    def _get_field_value(cls, data: Dict[str, Any], field_id: str) -> Optional[Any]:
        """Extract field value trying both with and without 'f' prefix"""
        # Try with 'f' prefix first
        f_key = f"f{field_id}"
        if f_key in data:
            return data[f_key]

        # Try without prefix
        if field_id in data:
            return data[field_id]

        return None

    @classmethod
    def _extract_personal_details(cls, data: Dict[str, Any]) -> Dict[str, Any]:
        """Extract personal details from form data"""
        personal = {}

        for field_name, field_id in cls.PERSONAL_FIELDS.items():
            value = cls._get_field_value(data, field_id)
            if value:
                # Convert boolean strings for self-employed status
                if 'self_employed' in field_name:
                    personal[field_name] = cls._is_checked(value)
                # Parse income fields
                elif 'income' in field_name:
                    personal[field_name] = cls._parse_currency(value)
                else:
                    personal[field_name] = value

        return personal

    @classmethod
    def _extract_assets(cls, data: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Extract all assets (up to 15) from form data"""
        assets = []

        for i in range(1, 16):
            name_field = f'asset_{i}_name'
            value_field = f'asset_{i}_value'

            if name_field in cls.ASSET_FIELDS and value_field in cls.ASSET_FIELDS:
                name = cls._get_field_value(data, cls.ASSET_FIELDS[name_field])
                value = cls._get_field_value(data, cls.ASSET_FIELDS[value_field])

                if name and value:
                    assets.append({
                        'name': name,
                        'value': cls._parse_currency(value)
                    })

        return assets

    @classmethod
    def _extract_liabilities(cls, data: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Extract all liabilities (up to 5) from form data"""
        liabilities = []

        for i in range(1, 6):
            name_field = f'liability_{i}_name'
            value_field = f'liability_{i}_value'

            if name_field in cls.LIABILITY_FIELDS and value_field in cls.LIABILITY_FIELDS:
                name = cls._get_field_value(data, cls.LIABILITY_FIELDS[name_field])
                value = cls._get_field_value(data, cls.LIABILITY_FIELDS[value_field])

                if name and value:
                    liabilities.append({
                        'name': name,
                        'value': cls._parse_currency(value)
                    })

        return liabilities

    @classmethod
    def _extract_kiwisaver(cls, data: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Extract KiwiSaver account information (up to 3 accounts)"""
        accounts = []

        # Account 1
        provider1 = cls._get_field_value(data, cls.ASSET_FIELDS['kiwisaver_1_provider'])
        balance1 = cls._get_field_value(data, cls.ASSET_FIELDS['kiwisaver_1_balance'])
        if provider1 or balance1:
            accounts.append({
                'provider': provider1 or 'Unknown Provider',
                'balance': cls._parse_currency(balance1)
            })

        # Account 2
        provider2 = cls._get_field_value(data, cls.ASSET_FIELDS['kiwisaver_2_provider'])
        balance2 = cls._get_field_value(data, cls.ASSET_FIELDS['kiwisaver_2_balance'])
        if provider2 or balance2:
            accounts.append({
                'provider': provider2 or 'Unknown Provider',
                'balance': cls._parse_currency(balance2)
            })

        # Account 3
        provider3 = cls._get_field_value(data, cls.ASSET_FIELDS['kiwisaver_3_provider'])
        balance3 = cls._get_field_value(data, cls.ASSET_FIELDS['kiwisaver_3_balance'])
        if provider3 or balance3:
            accounts.append({
                'provider': provider3 or 'Unknown Provider',
                'balance': cls._parse_currency(balance3)
            })

        return accounts

    @classmethod
    def _parse_currency(cls, value: Any) -> float:
        """Parse currency string to float value"""
        if value is None or value == '':
            return 0.0

        if isinstance(value, (int, float)):
            return float(value)

        if isinstance(value, str):
            # Remove currency symbols and formatting
            cleaned = re.sub(r'[^\d.-]', '', value.replace(',', ''))
            try:
                return float(cleaned) if cleaned else 0.0
            except ValueError:
                return 0.0

        return 0.0

    @classmethod
    def _is_checked(cls, value: Any) -> bool:
        """Convert various checkbox representations to boolean"""
        if value is None:
            return False

        if isinstance(value, bool):
            return value

        if isinstance(value, str):
            value_lower = value.lower().strip()
            return value_lower in ['yes', 'true', '1', 'checked', 'on', 'x', 'self employed', 'self-employed']

        return bool(value)

    @classmethod
    def _calculate_age(cls, date_of_birth: Optional[str]) -> Optional[int]:
        """Calculate age from date of birth"""
        if not date_of_birth:
            return None

        try:
            # Try various date formats
            for fmt in ['%Y-%m-%d', '%d/%m/%Y', '%m/%d/%Y', '%d-%m-%Y']:
                try:
                    dob = datetime.strptime(str(date_of_birth), fmt).date()
                    today = date.today()
                    age = today.year - dob.year - ((today.month, today.day) < (dob.month, dob.day))
                    return age
                except ValueError:
                    continue
        except Exception:
            pass

        return None

    @classmethod
    def _calculate_total_assets(cls, assets: List[Dict], kiwisaver: List[Dict],
                               raw_data: Dict[str, Any]) -> float:
        """Calculate total assets including property and KiwiSaver"""
        total = 0.0

        # Add house value
        house_value = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['house_value'])
        )
        total += house_value

        # Add investment properties
        property_value = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_value'])
        )
        total += property_value

        # Add KiwiSaver balances
        for account in kiwisaver:
            total += account.get('balance', 0)

        # Add other assets
        for asset in assets:
            total += asset.get('value', 0)

        # Check if there's a pre-calculated total and use the higher value
        stated_total = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['asset_total'])
        )

        return max(total, stated_total)

    @classmethod
    def _calculate_total_liabilities(cls, liabilities: List[Dict],
                                   raw_data: Dict[str, Any]) -> float:
        """Calculate total liabilities including mortgages"""
        total = 0.0

        # Add home mortgage
        mortgage = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['mortgage'])
        )
        total += mortgage

        # Add investment property debt
        property_debt = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_debt'])
        )
        total += property_debt

        # Add other liabilities
        for liability in liabilities:
            total += liability.get('value', 0)

        return total

    @classmethod
    def _calculate_net_worth(cls, total_assets: float, total_liabilities: float) -> float:
        """Calculate net worth (assets minus liabilities)"""
        return total_assets - total_liabilities

    @classmethod
    def _calculate_property_equity(cls, raw_data: Dict[str, Any]) -> float:
        """Calculate total property equity"""
        # Home equity
        house_value = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['house_value'])
        )
        mortgage = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['mortgage'])
        )
        home_equity = house_value - mortgage

        # Investment property equity
        property_value = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_value'])
        )
        property_debt = cls._parse_currency(
            cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_debt'])
        )
        investment_equity = property_value - property_debt

        return home_equity + investment_equity

    @classmethod
    def _calculate_total_income(cls, personal_data: Dict[str, Any]) -> float:
        """Calculate total household income"""
        main_income = personal_data.get('main_annual_income', 0)
        partner_income = personal_data.get('partner_annual_income', 0)
        return main_income + partner_income

    @classmethod
    def _calculate_debt_to_income_ratio(cls, total_debt: float, total_income: float) -> float:
        """Calculate debt-to-income ratio as percentage"""
        if total_income == 0:
            return 0.0
        return round((total_debt / total_income) * 100, 1)

    @classmethod
    def _format_currency(cls, amount: float) -> str:
        """Format amount as currency string"""
        return f"${amount:,.0f}"

    @classmethod
    def _get_age_description(cls, age: Optional[int]) -> str:
        """Get age range description"""
        if age is None:
            return "age unknown"
        elif age < 30:
            return "young professional"
        elif age < 40:
            return "early career"
        elif age < 50:
            return "mid-career"
        elif age < 60:
            return "late career"
        elif age < 70:
            return "pre-retirement/early retirement"
        else:
            return "retirement age"

    @classmethod
    def _get_financial_position_description(cls, net_worth: float) -> str:
        """Get financial position description based on net worth"""
        if net_worth < 0:
            return "net debt position"
        elif net_worth < 100000:
            return "building wealth"
        elif net_worth < 500000:
            return "established financial position"
        elif net_worth < 1000000:
            return "strong financial position"
        elif net_worth < 2000000:
            return "high net worth"
        else:
            return "very high net worth"

    @classmethod
    def _get_income_level_description(cls, income: float) -> str:
        """Get income level description"""
        if income < 50000:
            return "modest income"
        elif income < 100000:
            return "average income"
        elif income < 150000:
            return "above-average income"
        elif income < 250000:
            return "high income"
        else:
            return "very high income"

    @classmethod
    def _get_all_raw_fields(cls, data: Dict[str, Any]) -> Dict[str, Any]:
        """Get all relevant raw field values"""
        raw_fields = {}

        # Personal fields
        for field_name, field_id in cls.PERSONAL_FIELDS.items():
            raw_fields[f'field_{field_id}'] = cls._get_field_value(data, field_id)

        # Asset fields
        for field_name, field_id in cls.ASSET_FIELDS.items():
            raw_fields[f'field_{field_id}'] = cls._get_field_value(data, field_id)

        # Liability fields
        for field_name, field_id in cls.LIABILITY_FIELDS.items():
            raw_fields[f'field_{field_id}'] = cls._get_field_value(data, field_id)

        return raw_fields

    # Content generation methods for each section

    @classmethod
    def _generate_personal_summary(cls, personal_data: Dict, age: Optional[int],
                                  is_couple: bool, client_name: Optional[str]) -> str:
        """Generate personal summary content"""
        name = client_name or "The client"
        age_str = f"{age} years old" if age else "age not specified"
        occupation = personal_data.get('main_occupation', 'occupation not specified')

        if is_couple:
            partner_occupation = personal_data.get('partner_occupation', 'occupation not specified')
            return f"{name} is {age_str}, working as {occupation}. Partner works as {partner_occupation}. This couple is seeking comprehensive insurance advice as part of their financial planning."
        else:
            return f"{name} is {age_str}, working as {occupation}. They are seeking insurance advice to protect their financial position and secure their future."

    @classmethod
    def _generate_employment_status(cls, personal_data: Dict, total_income: float,
                                   is_couple: bool) -> str:
        """Generate employment status content"""
        main_employed = "self-employed" if personal_data.get('main_self_employed') else "employed"
        main_employer = personal_data.get('main_employer', 'employer not specified')
        main_income = personal_data.get('main_annual_income', 0)

        content = f"Primary income earner is {main_employed}"
        if main_employed == "employed":
            content += f" by {main_employer}"
        content += f" with annual income of {cls._format_currency(main_income)}."

        if is_couple and personal_data.get('partner_occupation'):
            partner_employed = "self-employed" if personal_data.get('partner_self_employed') else "employed"
            partner_employer = personal_data.get('partner_employer', 'employer not specified')
            partner_income = personal_data.get('partner_annual_income', 0)

            content += f" Partner is {partner_employed}"
            if partner_employed == "employed":
                content += f" by {partner_employer}"
            content += f" earning {cls._format_currency(partner_income)} annually."

        content += f" Combined household income: {cls._format_currency(total_income)}."

        return content[:600]

    @classmethod
    def _generate_asset_summary(cls, total_assets: float, assets: List[Dict],
                               raw_data: Dict[str, Any]) -> str:
        """Generate asset summary content"""
        house_value = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['house_value']))
        property_value = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_value']))

        content = f"Total assets valued at {cls._format_currency(total_assets)}."

        if house_value > 0:
            content += f" Primary residence valued at {cls._format_currency(house_value)}."

        if property_value > 0:
            content += f" Investment property portfolio worth {cls._format_currency(property_value)}."

        if assets:
            content += f" Additional assets include {len(assets)} items:"
            for asset in assets[:3]:
                content += f" {asset['name']} ({cls._format_currency(asset['value'])});"
            if len(assets) > 3:
                content += f" and {len(assets) - 3} more."

        return content[:600]

    @classmethod
    def _generate_liability_summary(cls, total_liabilities: float, liabilities: List[Dict],
                                   raw_data: Dict[str, Any]) -> str:
        """Generate liability summary content"""
        mortgage = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['mortgage']))
        property_debt = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_debt']))

        if total_liabilities == 0:
            return "No significant liabilities reported. Debt-free position provides strong financial flexibility."

        content = f"Total liabilities of {cls._format_currency(total_liabilities)}."

        if mortgage > 0:
            content += f" Home mortgage: {cls._format_currency(mortgage)}."

        if property_debt > 0:
            content += f" Investment property debt: {cls._format_currency(property_debt)}."

        if liabilities:
            other_debt = sum(l['value'] for l in liabilities)
            if other_debt > 0:
                content += f" Other debts total {cls._format_currency(other_debt)}."

        return content[:500]

    @classmethod
    def _generate_net_worth_position(cls, net_worth: float, assets: float, liabilities: float) -> str:
        """Generate net worth position content"""
        position = cls._get_financial_position_description(net_worth)

        content = f"Net worth of {cls._format_currency(net_worth)} represents {position}. "
        content += f"Assets of {cls._format_currency(assets)} exceed liabilities of {cls._format_currency(liabilities)} "

        if net_worth > 0:
            if liabilities > 0:
                leverage_ratio = round((liabilities / assets) * 100, 1)
                content += f"with leverage ratio of {leverage_ratio}%. "
            else:
                content += "with no debt leverage. "
            content += "This position provides good capacity for insurance premiums."
        else:
            content += "indicating need for careful premium budgeting."

        return content[:400]

    @classmethod
    def _generate_kiwisaver_status(cls, kiwisaver_accounts: List[Dict]) -> str:
        """Generate KiwiSaver status content"""
        if not kiwisaver_accounts:
            return "No KiwiSaver accounts reported. Consider establishing retirement savings through KiwiSaver for long-term financial security."

        total_balance = sum(acc.get('balance', 0) for acc in kiwisaver_accounts)

        content = f"KiwiSaver holdings total {cls._format_currency(total_balance)} across {len(kiwisaver_accounts)} account(s)."

        for i, account in enumerate(kiwisaver_accounts, 1):
            provider = account.get('provider', 'Unknown')
            balance = account.get('balance', 0)
            content += f" Account {i}: {provider} ({cls._format_currency(balance)})."

        if total_balance < 50000:
            content += " Consider increasing contributions for retirement planning."

        return content[:400]

    @classmethod
    def _generate_property_position(cls, property_equity: float, raw_data: Dict[str, Any]) -> str:
        """Generate property position content"""
        house_value = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['house_value']))
        mortgage = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['mortgage']))
        property_value = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_value']))
        property_debt = cls._parse_currency(cls._get_field_value(raw_data, cls.ASSET_FIELDS['total_property_debt']))

        if house_value == 0 and property_value == 0:
            return "No property ownership reported. Currently renting or other living arrangements."

        content = f"Total property equity of {cls._format_currency(property_equity)}."

        if house_value > 0:
            home_equity = house_value - mortgage
            ltv = round((mortgage / house_value * 100), 1) if house_value > 0 else 0
            content += f" Home valued at {cls._format_currency(house_value)} with {ltv}% LTV,"
            content += f" providing {cls._format_currency(home_equity)} equity."

        if property_value > 0:
            investment_equity = property_value - property_debt
            content += f" Investment properties: {cls._format_currency(property_value)} value,"
            content += f" {cls._format_currency(investment_equity)} equity."

        return content[:500]

    @classmethod
    def _generate_estate_planning(cls, will_status: Optional[str], is_couple: bool) -> str:
        """Generate estate planning content"""
        if not will_status:
            return "Will and Enduring Power of Attorney status not specified. Recommend reviewing estate planning documents alongside insurance arrangements."

        will_lower = str(will_status).lower()

        if any(word in will_lower for word in ['yes', 'complete', 'done', 'current', 'updated']):
            return f"Will and EPA documents are in place. Estate planning appears current. Regular review recommended to ensure alignment with insurance beneficiaries."
        elif any(word in will_lower for word in ['no', 'none', 'needed', 'required']):
            return f"Will and/or EPA not in place. Strongly recommend establishing estate planning documents to ensure wishes are carried out and complement insurance arrangements."
        else:
            return f"Estate planning status: {will_status}. Review recommended to ensure current and aligned with insurance planning."

    @classmethod
    def _generate_key_observations(cls, net_worth: float, debt_to_income: float,
                                  kiwisaver_accounts: List[Dict], property_equity: float) -> str:
        """Generate key observations content"""
        observations = []

        # Net worth observation
        position = cls._get_financial_position_description(net_worth)
        observations.append(f"{position} with net worth of {cls._format_currency(net_worth)}")

        # Debt observation
        if debt_to_income > 300:
            observations.append("high debt-to-income ratio requires careful consideration")
        elif debt_to_income < 100:
            observations.append("conservative debt position provides flexibility")

        # Property observation
        if property_equity > 500000:
            observations.append("substantial property equity provides security")

        # KiwiSaver observation
        ks_total = sum(acc.get('balance', 0) for acc in kiwisaver_accounts)
        if ks_total == 0:
            observations.append("no retirement savings through KiwiSaver")
        elif ks_total > 100000:
            observations.append("good retirement savings accumulation")

        content = "Key observations: " + "; ".join(observations[:4]) + "."

        return content[:500]

    @classmethod
    def _generate_financial_capacity(cls, income: float, net_worth: float,
                                    debt_to_income: float) -> str:
        """Generate financial capacity for premiums content"""
        income_level = cls._get_income_level_description(income)

        # Calculate suggested premium capacity (rough estimate: 5-10% of income)
        min_premium = income * 0.05
        max_premium = income * 0.10

        content = f"With {income_level} of {cls._format_currency(income)} annually, "

        if net_worth > 0:
            content += f"and positive net worth of {cls._format_currency(net_worth)}, "
            content += f"client has capacity for insurance premiums in range of "
            content += f"{cls._format_currency(min_premium/12)}-{cls._format_currency(max_premium/12)} monthly."
        else:
            content += f"and current debt position, "
            content += f"recommend conservative premium budget of "
            content += f"{cls._format_currency(min_premium/12)} monthly."

        if debt_to_income > 200:
            content += " High debt levels suggest careful premium structuring needed."

        return content[:400]


def generate_where_are_you_now_json(raw_form_data: Dict[str, Any],
                                   client_name: Optional[str] = None,
                                   is_couple: bool = False) -> Dict[str, Any]:
    """
    Main function to generate Where Are You Now JSON structure

    Args:
        raw_form_data: Raw form data from Gravity Forms
        client_name: Optional client name for personalization
        is_couple: Whether this is for a couple

    Returns:
        Structured JSON for Where Are You Now section
    """
    return WhereAreYouNowGenerator.generate_where_are_you_now_json(
        raw_form_data, client_name, is_couple
    )


# Example usage and testing
if __name__ == "__main__":
    # Example form data
    example_data = {
        # Personal details
        "f144": "John",  # Main first name
        "f146": "Jane",  # Partner first name
        "f95": "1985-03-15",  # Date of birth
        "f482": "No",  # Main self-employed
        "f483": "Yes",  # Partner self-employed
        "f6": "Software Engineer",  # Main occupation
        "f40": "Marketing Consultant",  # Partner occupation
        "f277": "Tech Corp Ltd",  # Main employer
        "f297": "Self",  # Partner employer
        "f10": "$120,000",  # Main income
        "f42": "$85,000",  # Partner income
        "f501": "Yes - current",  # Will & EPA status

        # Assets
        "f16": "850000",  # House value
        "f15": "450000",  # Mortgage
        "f468": "350000",  # Total property value
        "f469": "280000",  # Total property debt
        "f60": "ANZ",  # KiwiSaver provider 1
        "f61": "45000",  # KiwiSaver balance 1
        "f62": "Westpac",  # KiwiSaver provider 2
        "f215": "32000",  # KiwiSaver balance 2
        "f33": "Savings Account",  # Asset 1 name
        "f26": "25000",  # Asset 1 value
        "f34": "Term Deposit",  # Asset 2 name
        "f28": "50000",  # Asset 2 value

        # Liabilities
        "f71": "Credit Card",  # Liability 1 name
        "f72": "5000",  # Liability 1 value
        "f73": "Car Loan",  # Liability 2 name
        "f74": "15000"  # Liability 2 value
    }

    # Generate JSON structure
    result = generate_where_are_you_now_json(
        example_data,
        client_name="John and Jane Smith",
        is_couple=True
    )

    # Pretty print the result
    print(json.dumps(result, indent=2))